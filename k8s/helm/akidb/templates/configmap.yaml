apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "akidb.configMapName" . }}
  labels:
    {{- include "akidb.labels" . | nindent 4 }}
data:
  config.toml: |
    # AkiDB Configuration
    # Generated by Helm chart

    [server]
    host = "0.0.0.0"
    rest_port = {{ .Values.service.rest.targetPort }}
    grpc_port = {{ .Values.service.grpc.targetPort }}

    [logging]
    level = "{{ .Values.config.logLevel }}"
    format = "{{ .Values.config.logFormat }}"

    [database]
    path = "{{ .Values.config.database.path }}"
    journal_mode = "{{ .Values.config.database.journalMode }}"
    synchronous = "{{ .Values.config.database.synchronous }}"
    cache_size = {{ .Values.config.database.cacheSize }}

    [hot_tier]
    max_memory_bytes = {{ .Values.config.hotTier.maxMemoryBytes }}
    max_collections = {{ .Values.config.hotTier.maxCollections }}

    [warm_tier]
    path = "{{ .Values.config.warmTier.path }}"
    max_size_bytes = {{ .Values.config.warmTier.maxSizeBytes }}

    {{- if .Values.config.coldTier.enabled }}
    [cold_tier]
    enabled = true
    type = "{{ .Values.config.coldTier.type }}"
    bucket = "{{ .Values.config.coldTier.bucket }}"
    region = "{{ .Values.config.coldTier.region }}"
    {{- if .Values.config.coldTier.prefix }}
    prefix = "{{ .Values.config.coldTier.prefix }}"
    {{- end }}
    {{- if .Values.config.coldTier.endpoint }}
    endpoint = "{{ .Values.config.coldTier.endpoint }}"
    {{- end }}
    {{- end }}

    {{- if .Values.config.tiering.enabled }}
    [tiering]
    enabled = true
    demotion_idle_threshold = "{{ .Values.config.tiering.demotionIdleThreshold }}"
    promotion_access_threshold = {{ .Values.config.tiering.promotionAccessThreshold }}
    worker_interval = "{{ .Values.config.tiering.workerInterval }}"
    {{- end }}

    [observability]
    metrics_enabled = {{ .Values.config.observability.metricsEnabled }}
    tracing_enabled = {{ .Values.config.observability.tracingEnabled }}
    {{- if .Values.config.observability.jaegerEndpoint }}
    jaeger_endpoint = "{{ .Values.config.observability.jaegerEndpoint }}"
    {{- end }}
    tracing_sample_rate = {{ .Values.config.observability.tracingSampleRate }}
